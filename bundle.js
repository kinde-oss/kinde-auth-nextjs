"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("react"),t=require("crypto-js"),r=require("jwt-decode");function o(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var s=o(e),a=o(r);const c=process.env.KINDE_SITE_URL,i=process.env.KINDE_ISSUER_URL,n=process.env.KINDE_POST_LOGOUT_REDIRECT_URL,u={initialState:{user:null,isLoading:!0,checkSession:null},SESSION_PREFIX:"pkce-verifier",redirectURL:c,issuerURL:i,clientID:process.env.KINDE_CLIENT_ID,clientSecret:process.env.KINDE_CLIENT_SECRET,postLogoutRedirectURL:n,responseType:"code",scope:"openid offline",codeChallengeMethod:"S256",redirectRoutes:{callback:"/api/auth/kinde_callback"},issuerRoutes:{logout:"/logout",login:"/oauth2/auth",register:"/oauth2/auth",token:"/oauth2/token",profile:"/oauth2/user_profile"}},l=()=>{throw new Error("Oops! Seems like you forgot to wrap your app in <KindeProvider>.")},d=e.createContext({...u.initialState,user:l,isLoading:l}),_=require("crypto"),h=()=>_.randomBytes(28).toString("hex");function g(){const e=h(),r=function(e){return t.SHA256(e).toString(t.enc.Base64url)}(e);return{code_verifier:e,code_challenge:r}}var p=require("cookie");const R=(e,t,r)=>{const o=h(),{code_challenge:s,code_verifier:a}=g();return t.setHeader("Set-Cookie",p.serialize(`${u.SESSION_PREFIX}-${o}`,a,{httpOnly:!0,maxAge:r})),{state:o,code_challenge:s}};var k=require("cookie");var y=require("cookie");var S=require("cookie");exports.KindeProvider=({children:t})=>{const[r,o]=e.useState({...u.initialState}),a="/api/auth/me",c=e.useCallback((async()=>{try{const e=await(async e=>{let t;try{t=await fetch(e)}catch{throw new RequestError(0)}if(t.ok)return t.json();t.status})(a);o((t=>({...t,user:e,error:void 0})))}catch(e){o((t=>({...t,error:e})))}}),[a]);e.useEffect((()=>{r.user||(async()=>{await c(),o((e=>({...e,isLoading:!1})))})()}),[r.user]);const{user:i,error:n,isLoading:l}=r;return s.default.createElement(d.Provider,{value:{user:i,error:n,isLoading:l,isAuthenticated:!!i}},t)},exports.handleAuth=()=>async function(e,t){let{query:{kindeAuth:r}}=e;switch(r=Array.isArray(r)?r[0]:r,r){case"login":return await(async(e,t)=>{const r=e.query,{org_code:o,is_create_org:s,org_name:a=""}=r,{state:c,code_challenge:i}=R(0,t,60),n=new URL(u.issuerURL+u.issuerRoutes.login);let l={redirect_uri:u.redirectURL+u.redirectRoutes.callback,client_id:u.clientID,response_type:u.responseType,scope:u.scope,code_challenge:i,code_challenge_method:u.codeChallengeMethod,state:c,start_page:"login"};o&&(l.org_code=o),s&&(l.is_create_org=s,l.org_name=a),n.search=new URLSearchParams(l),t.redirect(n.href)})(e,t);case"register":return await(async(e,t)=>{const r=e.query,{org_code:o,is_create_org:s,org_name:a=""}=r,{state:c,code_challenge:i}=R(0,t,180),n=new URL(u.issuerURL+u.issuerRoutes.register);let l={redirect_uri:u.redirectURL+u.redirectRoutes.callback,client_id:u.clientID,response_type:u.responseType,scope:u.scope,code_challenge:i,code_challenge_method:u.codeChallengeMethod,state:c,start_page:"registration"};o&&(l.org_code=o),s&&(l.is_create_org=s,l.org_name=a),n.search=new URLSearchParams(l),t.redirect(n.href)})(e,t);case"me":return await(async(e,t)=>{const r=y.parse(e.headers.cookie||"").kinde_token;if(r){const e=JSON.parse(r);try{const r=await fetch(u.issuerURL+u.issuerRoutes.profile,{headers:new Headers({Authorization:"Bearer "+e.access_token})}),o=await r.json();t.send(o)}catch(e){console.log(e)}}else t.status(401).send("Unauthorized")})(e,t);case"logout":return await(async(e,t)=>{t.setHeader("Set-Cookie",k.serialize("kinde_token",null,{httpOnly:!0,expires:new Date(0),sameSite:"lax",path:"/"}));const r=new URL(u.issuerURL+u.issuerRoutes.logout);r.searchParams.set("redirect",u.postLogoutRedirectURL),t.redirect(r.href)})(0,t);case"kinde_callback":return await(async(e,t)=>{const{code:r,state:o}=e.query,s=S.parse(e.headers.cookie||"")[`${u.SESSION_PREFIX}-${o}`];if(s){try{const e=await fetch(u.issuerURL+u.issuerRoutes.token,{method:"POST",headers:new Headers({"Content-type":"application/x-www-form-urlencoded; charset=UTF-8"}),body:new URLSearchParams({client_id:u.clientID,client_secret:u.clientSecret,code:r,code_verifier:s,grant_type:"authorization_code",redirect_uri:u.redirectURL+u.redirectRoutes.callback})}),o=await e.json(),c=a.default(o.access_token,{header:!0});a.default(o.access_token).iss==u.issuerURL&&"RS256"==c.alg&&t.setHeader("Set-Cookie",S.serialize("kinde_token",JSON.stringify(o),{httpOnly:!0,maxAge:3600,sameSite:"lax",path:"/"}))}catch(e){console.log(e)}t.redirect(u.redirectURL)}else t.redirect(u.redirectURL)})(e,t);case"create_org":return await(async(e,t)=>{const r=e.query,{org_name:o="",start_page:s="registration"}=r,{state:a,code_challenge:c}=R(0,t,60),i=new URL(u.issuerURL+u.issuerRoutes.login);let n={redirect_uri:u.redirectURL+u.redirectRoutes.callback,client_id:u.clientID,response_type:u.responseType,scope:u.scope,code_challenge:c,code_challenge_method:u.codeChallengeMethod,state:a,start_page:s,is_create_org:!0,org_name:o};i.search=new URLSearchParams(n),t.redirect(i.href)})(e,t);case"get_token":return await(async(e,t)=>{e.cookies.kinde_token?t.status(200).json(JSON.parse(e.cookies.kinde_token)):t.status(500).json({message:"There is no kinde_token, you are not authenticated. Try logging in."})})(e,t);default:return t.status(404).end()}},exports.useKindeAuth=()=>e.useContext(d);
